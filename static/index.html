<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="OT Early Warning System - Dashboard di monitoraggio protocolli OT e rilevamento anomalie" />
  <title>OT EWS</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --green: #16a34a;
      --yellow: #eab308;
      --red: #dc2626;
      --gray: #64748b;
      --blue: #2563eb;
    }
    body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 12px 16px; background: #020617; display: flex; align-items: center; justify-content: space-between; }
    header h1 { margin: 0; font-size: 18px; }
    nav button { margin-right: 8px; background: var(--panel); color: var(--text); border: 1px solid #334155; padding: 8px 10px; cursor: pointer; }
    nav button.active { background: var(--blue); border-color: var(--blue); }
    main { padding: 16px; }
    section { display: none; }
    section.active { display: block; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { background: var(--panel); border: 1px solid #334155; border-left-width: 8px; padding: 10px; }
    .state-gray { border-left-color: var(--gray); }
    .state-green { border-left-color: var(--green); }
    .state-yellow { border-left-color: var(--yellow); }
    .state-red { border-left-color: var(--red); }
    .muted { color: var(--muted); }
    .line { margin: 4px 0; }
    input, select, button, textarea { background: #0b1220; color: var(--text); border: 1px solid #334155; padding: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #334155; padding: 6px; font-size: 13px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .pill { border-radius: 12px; padding: 2px 8px; font-size: 12px; }
    .sev-warning { background: #854d0e; }
    .sev-alarm { background: #7f1d1d; }
    pre { background: #0b1220; border: 1px solid #334155; padding: 8px; overflow: auto; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px; }
    .badge-green { background: #166534; }
    .badge-red { background: #7f1d1d; }
    .badge-blue { background: #1e3a5f; }
    #authRow { background: #1a1a2e; padding: 8px 16px; border-bottom: 1px solid #334155; display: flex; align-items: center; gap: 10px; font-size: 13px; }
    #authRow input { width: 300px; }
    .stats-bar { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
    .stat-chip { background: var(--panel); border: 1px solid #334155; padding: 6px 12px; font-size: 13px; }
  </style>
</head>
<body>
  <header>
    <h1>OT Early Warning System</h1>
    <div id="statusBar" class="muted">Caricamento...</div>
  </header>

  <div id="authRow">
    <label>API Key: <input id="apiKeyInput" type="password" placeholder="Inserisci API key (se configurata)" /></label>
    <span id="authStatus" class="muted">Non verificata</span>
  </div>

  <main>
    <nav>
      <button class="tab active" data-target="dashboard">Dashboard</button>
      <button class="tab" data-target="events">Eventi</button>
      <button class="tab" data-target="state">Stato</button>
      <button class="tab" data-target="config">Configurazione</button>
    </nav>

    <section id="dashboard" class="active">
      <h2>Dashboard Protocolli OT</h2>
      <div class="row">
        <button id="clearAlerts" style="background:#7f1d1d;border-color:#991b1b;">&#128465; Cancella Warning e Allarmi</button>
      </div>
      <div id="dashStats" class="stats-bar"></div>
      <div id="cards" class="grid"></div>
    </section>

    <section id="events">
      <h2>Eventi</h2>
      <div class="row">
        <label>Severity
          <select id="filterSeverity">
            <option value="">Tutte</option>
            <option value="WARNING">WARNING</option>
            <option value="ALARM">ALARM</option>
          </select>
        </label>
        <label>Protocollo <input id="filterProtocol" placeholder="es. Profinet" /></label>
        <label>Host <input id="filterHost" placeholder="IP o MAC" /></label>
        <label>Ultimi secondi <input id="filterSince" type="number" min="1" value="3600" /></label>
        <button id="reloadEvents">Ricarica</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Severity</th>
            <th>Protocollo</th>
            <th>Src</th>
            <th>Dst</th>
            <th>Port/EtherType</th>
            <th>Occorrenze</th>
            <th>Descrizione</th>
          </tr>
        </thead>
        <tbody id="eventsTable"></tbody>
      </table>
    </section>

    <section id="state">
      <h2>Stato Sistema</h2>
      <div class="row">
        <span>Stato attuale: <strong id="currentState">-</strong></span>
        <button id="btnOff">Imposta SPENTO (OFF)</button>
        <button id="btnOn">Imposta ACCESO (ON)</button>
      </div>
      <h3>Baseline protocolli</h3>
      <div id="baselineProtocols" class="muted">-</div>
    </section>

    <section id="config">
      <h2>Configurazione</h2>
      <div class="row">
        <label>Dedup seconds <input id="dedupInput" type="number" min="1" max="3600" /></label>
        <button id="saveConfig">Salva config runtime</button>
      </div>
      <pre id="configView"></pre>
      <h3>Baseline export/import</h3>
      <div class="row">
        <button id="exportBaseline">Export baseline (JSON)</button>
      </div>
      <textarea id="importPayload" rows="10" style="width:100%;" placeholder="Incolla qui JSON baseline"></textarea>
      <div class="row">
        <button id="importBaseline">Import baseline</button>
      </div>
    </section>
  </main>

  <script>
    // â”€â”€ XSS-safe text escaping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function esc(s) {
      if (s === null || s === undefined) return '';
      const d = document.createElement('div');
      d.textContent = String(s);
      return d.innerHTML;
    }

    let authEnabled = false;

    // â”€â”€ Sound management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const warningSound = new Audio('/sound/warning.mp3');
    const alarmSound = new Audio('/sound/allarm.mp3');
    let currentSoundPriority = 0; // 0=none, 1=warning, 2=alarm
    let lastSoundCheckTime = Date.now() / 1000;
    let soundInitialized = false;

    alarmSound.addEventListener('ended', () => { currentSoundPriority = 0; });
    warningSound.addEventListener('ended', () => {
      if (currentSoundPriority === 1) currentSoundPriority = 0;
    });

    function playAlertSound(severity) {
      if (severity === 'ALARM') {
        if (currentSoundPriority < 2) {
          warningSound.pause();
          warningSound.currentTime = 0;
          currentSoundPriority = 2;
          alarmSound.currentTime = 0;
          alarmSound.play().catch(() => {});
        }
      } else if (severity === 'WARNING') {
        if (currentSoundPriority === 0) {
          currentSoundPriority = 1;
          warningSound.currentTime = 0;
          warningSound.play().catch(() => {});
        }
      }
    }

    function checkEventsForSound(events) {
      if (!soundInitialized) {
        soundInitialized = true;
        if (events.length > 0) {
          lastSoundCheckTime = Math.max(...events.map(e => e.last_seen || 0));
        }
        return;
      }
      let maxSeverity = null;
      for (const e of events) {
        if (e.last_seen > lastSoundCheckTime) {
          if (e.severity === 'ALARM') {
            maxSeverity = 'ALARM';
          } else if (e.severity === 'WARNING' && maxSeverity !== 'ALARM') {
            maxSeverity = 'WARNING';
          }
        }
      }
      if (events.length > 0) {
        const maxTs = Math.max(...events.map(e => e.last_seen || 0));
        if (maxTs > lastSoundCheckTime) {
          lastSoundCheckTime = maxTs;
        }
      }
      if (maxSeverity) {
        playAlertSound(maxSeverity);
      }
    }

    async function checkForNewSounds() {
      try {
        const data = await api('/api/events?since_seconds=15&limit=50');
        checkEventsForSound(data.items);
      } catch (e) { /* ignore sound check errors */ }
    }

    // â”€â”€ API key helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getApiKey() {
      return (document.getElementById('apiKeyInput').value || '').trim();
    }

    function setApiKey(value) {
      document.getElementById('apiKeyInput').value = value || '';
    }

    // â”€â”€ Tab navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(btn.dataset.target).classList.add('active');
    }));

    async function api(url, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      const key = getApiKey();
      const method = (options.method || 'GET').toUpperCase();
      if (authEnabled && method !== 'GET' && !key) {
        throw new Error('API key richiesta per questa operazione');
      }
      if (key) headers['X-Api-Key'] = key;
      const res = await fetch(url, { headers, ...options });
      if (!res.ok) {
        let detail = '';
        try {
          const payload = await res.json();
          detail = payload.detail || JSON.stringify(payload);
        } catch {
          detail = await res.text();
        }
        throw new Error(detail || ('HTTP ' + res.status));
      }
      return res.json();
    }

    function ts(t) {
      if (!t) return '-';
      return new Date(t * 1000).toLocaleString();
    }

    // â”€â”€ Dashboard cards (XSS-safe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCards(cards) {
      const host = document.getElementById('cards');
      host.innerHTML = '';
      for (const card of cards) {
        const el = document.createElement('div');
        el.className = 'card state-' + esc(card.color);

        // Header
        const h3 = document.createElement('h3');
        h3.textContent = card.protocol;
        el.appendChild(h3);

        // Stats lines
        const lines = [
          ['Pacchetti', card.packets],
          ['PPS', card.pps],
          ['BPS', card.bps],
        ];
        for (const [label, value] of lines) {
          const d = document.createElement('div');
          d.className = 'line';
          d.innerHTML = esc(label) + ': <strong>' + esc(value) + '</strong>';
          el.appendChild(d);
        }

        // Addresses
        const addrLabel = document.createElement('div');
        addrLabel.className = 'line muted';
        addrLabel.textContent = 'Indirizzi rilevati';
        addrLabel.style.marginTop = '8px';
        el.appendChild(addrLabel);
        if (card.addresses && card.addresses.length > 0) {
          for (const a of card.addresses) {
            const d = document.createElement('div');
            d.className = 'line';
            d.textContent = a.address + ' (' + a.count + ')';
            el.appendChild(d);
          }
        } else {
          const d = document.createElement('div');
          d.className = 'line muted';
          d.textContent = 'Nessun indirizzo';
          el.appendChild(d);
        }

        // Events
        const evtLabel = document.createElement('div');
        evtLabel.className = 'line muted';
        evtLabel.textContent = 'Ultimi eventi';
        evtLabel.style.marginTop = '8px';
        el.appendChild(evtLabel);
        if (card.events && card.events.length > 0) {
          for (const e of card.events) {
            const d = document.createElement('div');
            d.className = 'line';
            const pill = document.createElement('span');
            pill.className = 'pill ' + (e.severity === 'ALARM' ? 'sev-alarm' : 'sev-warning');
            pill.textContent = e.severity;
            d.textContent = ts(e.last_seen) + ' ';
            d.appendChild(pill);
            d.appendChild(document.createTextNode(' ' + (e.description || '')));
            el.appendChild(d);
          }
        } else {
          const d = document.createElement('div');
          d.className = 'line muted';
          d.textContent = 'Nessun evento';
          el.appendChild(d);
        }

        host.appendChild(el);
      }
    }

    async function refreshStatusAndMetrics() {
      const [status, metrics] = await Promise.all([api('/api/status'), api('/api/metrics')]);
      authEnabled = !!status.auth_enabled;

      // Status bar
      const parts = [
        'State=' + esc(status.state),
        'Mode=' + esc(status.mode),
        'eth0=' + esc(status.interfaces.eth0),
      ];
      if (status.interfaces.eth1) parts.push('eth1=' + esc(status.interfaces.eth1));
      parts.push('web=' + status.web.port);
      if (status.auth_enabled) parts.push('ðŸ”’ Auth');
      if (status.webhook_configured) parts.push('ðŸ“¡ Webhook');
      document.getElementById('statusBar').innerHTML = parts.join(' | ');

      // Auth status display
      const authEl = document.getElementById('authStatus');
      if (status.auth_enabled) {
        if (getApiKey()) {
          authEl.innerHTML = '<span class="badge badge-green">Auth attiva (key impostata)</span>';
        } else {
          authEl.innerHTML = '<span class="badge badge-red">Auth attiva (manca API key)</span>';
        }
      } else {
        authEl.innerHTML = '<span class="badge badge-red">Auth disattivata</span>';
      }

      document.getElementById('currentState').textContent = status.state;
      document.getElementById('baselineProtocols').textContent = metrics.baseline_protocols.join(', ') || 'Nessuno';

      // Stats bar
      const statsBar = document.getElementById('dashStats');
      const totalCards = metrics.cards.length;
      const activeCards = metrics.cards.filter(c => c.packets > 0).length;
      const alarmCards = metrics.cards.filter(c => c.color === 'red').length;
      const warnCards = metrics.cards.filter(c => c.color === 'yellow').length;
      statsBar.innerHTML = [
        '<div class="stat-chip">Protocolli monitorati: <strong>' + totalCards + '</strong></div>',
        '<div class="stat-chip">Con traffico: <strong>' + activeCards + '</strong></div>',
        '<div class="stat-chip" style="border-color:var(--red)">ALARM: <strong>' + alarmCards + '</strong></div>',
        '<div class="stat-chip" style="border-color:var(--yellow)">WARNING: <strong>' + warnCards + '</strong></div>',
        '<div class="stat-chip">Baseline: <strong>' + metrics.baseline_protocols.length + '</strong> proto</div>',
      ].join('');

      renderCards(metrics.cards);
    }

    // â”€â”€ Events table (XSS-safe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshEvents() {
      const severity = document.getElementById('filterSeverity').value;
      const protocol = document.getElementById('filterProtocol').value.trim();
      const host = document.getElementById('filterHost').value.trim();
      const since = document.getElementById('filterSince').value;
      const params = new URLSearchParams();
      if (severity) params.append('severity', severity);
      if (protocol) params.append('protocol', protocol);
      if (host) params.append('host', host);
      if (since) params.append('since_seconds', since);
      params.append('limit', '300');
      const data = await api('/api/events?' + params.toString());
      const tbody = document.getElementById('eventsTable');
      tbody.innerHTML = '';
      for (const e of data.items) {
        const tr = document.createElement('tr');
        const cells = [
          ts(e.last_seen),
          e.severity,
          e.protocol || '-',
          e.src_ip || e.src_mac || '-',
          e.dst_ip || e.dst_mac || '-',
          (e.port || '-') + ' / ' + (e.ethertype || '-'),
          e.occurrences,
          e.description,
        ];
        for (const val of cells) {
          const td = document.createElement('td');
          td.textContent = val != null ? String(val) : '-';
          tr.appendChild(td);
        }
        // Highlight ALARM rows
        if (e.severity === 'ALARM') {
          tr.style.background = '#1c0a0a';
        }
        tbody.appendChild(tr);
      }
    }

    async function refreshConfig() {
      const cfg = await api('/api/config');
      document.getElementById('configView').textContent = JSON.stringify(cfg, null, 2);
      document.getElementById('dedupInput').value = cfg.dedup_window_seconds;
    }

    document.getElementById('reloadEvents').addEventListener('click', async () => {
      try {
        await refreshEvents();
      } catch (e) {
        document.getElementById('statusBar').textContent = 'Errore eventi: ' + e.message;
      }
    });
    document.getElementById('btnOff').addEventListener('click', async () => {
      try {
        await api('/api/state', { method: 'POST', body: JSON.stringify({ state: 'OFF' }) });
        await refreshStatusAndMetrics();
      } catch (e) {
        alert('Impossibile impostare OFF: ' + e.message);
      }
    });
    document.getElementById('btnOn').addEventListener('click', async () => {
      try {
        await api('/api/state', { method: 'POST', body: JSON.stringify({ state: 'ON' }) });
        await refreshStatusAndMetrics();
      } catch (e) {
        alert('Impossibile impostare ON: ' + e.message);
      }
    });
    document.getElementById('saveConfig').addEventListener('click', async () => {
      try {
        const dedup = Number(document.getElementById('dedupInput').value);
        await api('/api/config', { method: 'POST', body: JSON.stringify({ dedup_window_seconds: dedup }) });
        await refreshConfig();
      } catch (e) {
        alert('Impossibile salvare configurazione: ' + e.message);
      }
    });
    document.getElementById('exportBaseline').addEventListener('click', async () => {
      try {
        const data = await api('/api/baseline/export', { method: 'POST' });
        document.getElementById('importPayload').value = JSON.stringify(data, null, 2);
      } catch (e) {
        alert('Impossibile esportare baseline: ' + e.message);
      }
    });
    document.getElementById('importBaseline').addEventListener('click', async () => {
      try {
        const payload = JSON.parse(document.getElementById('importPayload').value || '{}');
        await api('/api/baseline/import', { method: 'POST', body: JSON.stringify(payload) });
        await refreshStatusAndMetrics();
        await refreshConfig();
      } catch (e) {
        alert('Impossibile importare baseline: ' + e.message);
      }
    });

    document.getElementById('clearAlerts').addEventListener('click', async () => {
      try {
        await api('/api/events/clear', { method: 'POST' });
        await Promise.all([refreshStatusAndMetrics(), refreshEvents()]);
      } catch (e) {
        alert('Impossibile cancellare gli eventi: ' + e.message);
      }
    });

    async function boot() {
      try {
        const savedApiKey = localStorage.getItem('ews_api_key') || '';
        setApiKey(savedApiKey);
        document.getElementById('apiKeyInput').addEventListener('input', () => {
          localStorage.setItem('ews_api_key', getApiKey());
        });
        await Promise.all([refreshStatusAndMetrics(), refreshEvents(), refreshConfig()]);
      } catch (e) {
        document.getElementById('statusBar').textContent = 'Errore: ' + e.message;
      }
    }

    setInterval(async () => {
      try {
        await refreshStatusAndMetrics();
        await checkForNewSounds();
      } catch (e) {
        document.getElementById('statusBar').textContent = 'Errore status: ' + e.message;
      }
    }, 5000);
    setInterval(async () => {
      try {
        await refreshEvents();
      } catch {
        // keep polling even if one request fails
      }
    }, 7000);
    boot();
  </script>
</body>
</html>
